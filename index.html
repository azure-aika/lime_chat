<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0">
    <title>LIME風メッセージ画面</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://kit.fontawesome.com/deb1d71775.js" crossorigin="anonymous"></script>
</head>

<body>
    <div class="contents">
        <div class="screen">
            <div class="info-area">
                <div class="time"></div>
                <div class="battery"><span></span></div>
            </div>
            <div class="logo">LIME</div>
            <div class="header">
                <div class="menu"><i class="fa-solid fa-arrow-left"></i></div>
                <div class="sender">test</div>
                <div class="option"><i class="fa-solid fa-gear"></i></div>
            </div>
            <div class="chat-area">
                <div class="messageBox-left">
                    <div class="icon"><img></div>
                    <div class="message message-left">これはテストメッセージです</div>
                </div>
            </div>
            <form class="form-area" name="send">
                <button type="button" class="senderSelect sender-R"></button>

                <div class="textarea-bg">
                    <textarea id="text" class="textarea"></textarea>
                </div>

                <div class="formButton-submit">
                    <button type="submit" class="submit">送信</button>
                </div>
            </form>
        </div>
    </div>

</body>

<script>
    //Time
    time = document.getElementsByClassName('time');
    let timer = null;
    let timeTimer = null;

    const SetTime = () => {
        const now = new Date();
        let hours = now.getHours().toString();
        if (hours.length == 1) hours = '0' + hours;
        let minutes = now.getMinutes().toString();
        if (minutes.length == 1) minutes = '0' + minutes;
        time.textContent = String(hours) + ':' + String(minutes);
        timeTimer = setTimeout(SetTime, (60 - now.getSeconds()) * 1000);
    };
    //battery
    battery = document.querySelector('.battery span');
    batteryIcon = document.getElementById('batteryIcon');
    const batteryLevel = () => {
        navigator.getBattery().then((battery) => {
            battery.addEventListener("levelchange", () => {
                updateLevelInfo();
            });
            function updateLevelInfo() {
                batteryicon = document.createElement('i');
                /*
                if (0.75 < battery.level && battery.level <= 1) {
                    batteryIcon.classList.add('fa-battery-full');
                } else if (0.5 < battery.level && battery.level <= 0.75) {
                    batteryIcon.classList.remove('fa-battery-full').classList.add("fa-battery-three-quarters");
                } else if (0.25 < battery.level && battery.level <= 0.5) {
                    batteryIcon.classList.remove('fa-battery-full').classList.add("fa-battery-half");
                } else if (0.2 < battery.level && battery.level <= 0.25) {
                    batteryIcon.classList.remove('fa-battery-full').classList.add("fa-battery-quarter");
                } else if (0.1 < battery.level && battery.level <= 0.2) {
                    batteryIcon.classList.remove('fa-battery-full').classList.add("fa-battery-low");
                } else if (0 < battery.level && battery.level <= 0.1) {
                    batteryIcon.classList.remove('fa-battery-full').classList.add("fa-battery-empty");
                }*/
                if (0.75 < battery.level && battery.level <= 1) {
                    batteryicon.className = 'fa-solid fa-battery-full fa-lg';
                } else if (0.5 < battery.level && battery.level <= 0.75) {
                    batteryicon.className = 'fa-solid fa-battery-three-quarters fa-lg';
                } else if (0.25 < battery.level && battery.level <= 0.5) {
                    batteryicon.className = 'fa-solid fa-battery-half fa-lg';
                } else if (0.2 < battery.level && battery.level <= 0.25) {
                    batteryicon.className = 'fa-solid fa-battery-quarter fa-lg';
                } else if (0.1 < battery.level && battery.level <= 0.2) {
                    batteryicon.className = 'fa-solid fa-battery-low fa-lg';
                } else if (0 < battery.level && battery.level <= 0.1) {
                    batteryicon.className = 'fa-solid fa-battery-empty fa-lg';
                }
                document.querySelector('.battery').appendChild(batteryicon);
                level = battery.level * 100;
                document.querySelector('.battery span').textContent = String(level) + "%";
            };
            updateLevelInfo();
        });
    }
    //ブラウザ判定
    const batteryFlag = () => {
        const userAgent = window.navigator.userAgent.toLowerCase();
        if (userAgent.indexOf('edge') != -1 || userAgent.indexOf('chrome') != -1) {
            batteryLevel();
        } else if (userAgent.indexOf('safari') != -1) {
            battery.textContent = "123%";
        }
    }
    //テキストエリア自動伸縮
    const textBody = document.querySelector('#text');
    fontSize = (textBody.currentStyle || document.defaultView.getComputedStyle(textBody, '')).fontSize;
    lineHeight = (textBody.currentStyle || document.defaultView.getComputedStyle(textBody, '')).lineHeight;
    lineHeight = parseInt(lineHeight);
    const defaultHeight = (textBody.currentStyle || document.defaultView.getComputedStyle(textBody, '')).height;
    widthCountMax = 0;
    textBody.addEventListener('input', () => {
        length = textBody.value.length;
        row = Math.floor(textBody.scrollHeight / lineHeight);
        widthCount = Math.floor(length / row);
        if (widthCount >= widthCountMax) { widthCountMax = widthCount }
        if (textBody.scrollHeight >= lineHeight * 2) {
            textBody.style.height = 'auto';
            textBody.style.height = textBody.scrollHeight + 'px';
            if (length <= widthCountMax) {
                textBody.style.height = defaultHeight;
            }
        }
    });

    //senderSelect
    sender = document.querySelector('.senderSelect');
    senderflag = true;
    sender.addEventListener('click', function () {
        senderflag = !senderflag;
        sender.classList.toggle('sender-L');
        sender.classList.toggle('sender-R');
        console.log(senderflag);
    })

    //chat追加
    AddMessage = (text, position) => {
        //text = text.replace(/\s+/g, '');
        if (!text.length || !text.value == "") {
            textBody.textContent = "";
            textBody.style.height = defaultHeight;
            return;
        }
        senderflag ? position = 'right' : position = 'left';
        chatArea = document.getElementsByClassName('chat-area')[0];

        let fragment = document.createDocumentFragment();

        message = document.createElement('div');
        message.className = 'message message-' + position;
        message.textContent = text;


        if (!senderflag) {
            messageBox = document.createElement('div');
            messageBox.className = 'messageBox-left';
            icon = document.createElement('div');
            icon.className = 'icon';
            messageBox.appendChild(icon);
            messageBox.appendChild(message);
            fragment.append(messageBox);
        } else if (senderflag) {
            fragment.append(message);
        }

        chatArea.appendChild(fragment);
        textBody.value = "";
        textBody.style.height = defaultHeight;
        chatArea.scrollTop = chatArea.scrollHeight;

        /*messageEvent = document.getElementsByClassName('message');
        messageEvent.addEventListener('click', function () {
            let old_text = $(this).text();
            let new_text = window.prompt('メッセージ編集', old_text);
            if (new_text == null) {
                $(this).text(old_text);
                return;
            } else if (new_text == "") {
                if (window.confirm('削除しますか？')) {
                    $(this).remove();
                    return;
                }
            } else if (new_text.length) {
                $(this).text(new_text);
                return;
            }

        });*/

    };
    //メッセージ送信
    const form = document.querySelector('.form-area');
    form.addEventListener('submit', (e) => {
        e.preventDefault();
        let messageText = textBody.value;
        AddMessage(messageText);

    });



    SetTime();
    batteryFlag();
    //testメッセージ

</script>

</html>