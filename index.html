<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0">
    <title>LIME風メッセージ画面</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://kit.fontawesome.com/deb1d71775.js" crossorigin="anonymous"></script>
</head>

<body>
    <div class="screen">
        <div class="info">
            <div class="time" id="js-time"></div>
            <div class="battery" id="js-battery"><span></span></div>
        </div>
        <div class="logo">LIME</div>
        <div class="chat-wrapper">
            <div class="header">
                <div class="menuBtn menu-close" id="js-menuBtn"><i class="fa-solid fa-caret-right"></i></div>
                <div class="sender-name" id="js-sender-name"></div>
                <div class="option"><i class="fa-solid fa-gear"></i></div>
            </div>
            <div class="menu menu-close" id="js-menu">
                <div class="menu-list menu-list-active" id="js-chara-list">
                </div>
                <div class="menu-list" id="js-group-list">
                    <li></li>
                </div>
                <div class="menu-select" id="js-menu-select">
                    <button type="button" class="menu-select-btn menu-select-active">個人</button>
                    <button type="button" class="menu-select-btn">グループ</button>
                </div>

            </div>
        </div>
        <form class="form" name="send" id="js-form">
            <button type="button" class="form-sender form-sender-R"></button>
            <div class="textarea-bg">
                <textarea class="textarea" id="js-text"></textarea>
            </div>

            <div class="form-submit">
                <button type="submit" class="form-submit-btn">送信</button>
            </div>
        </form>
        <!-- <div class="modal">
            <form class="alert" name="alert" id="js-alert">
                <textarea class="textarea-re" id="js-text-re">sannpuru</textarea>
                <button type="button">変更</button>
                <button type="button">削除</button>
                <button type="button">キャンセル</button>

            </form>-->
    </div>


</body>

<script>
    //キャラデータ

    let CharaData = [
        { id: "0", name: "自分", username: "テスト", cate: "", color: "#808080", scenario: { 0: "スタマイに登場するチャットアプリ『LIME』を模したサイトです。", 1: "左の▶ボタンを押すと表示されるリストから、メッセージ送信相手を選択できます。", 2: "また、メッセージは【相手側】【自分側】どちらから送信されるのか、フォーム横のボタンで選択できます。", 3: "送信済のメッセージは、クリックすると編集画面にて変更できます。\n\n編集画面で、メッセージが空の状態でOKボタンを押すと、メッセージの削除ができます。", 4: "画面をリロードすると全会話が削除されます。" } },
        { id: "1", name: "青山樹", username: "青山樹", cate: "マトリ", color: "#2390FF", scenario: { 0: "青山樹です。登録よろしくお願いします。" } },
        { id: "2", name: "由井孝太郎", username: "Kotaro.Y", cate: "マトリ", color: "#FFAEC0", scenario: { 0: "いつでも連絡してくれ", 1: "キミからの頼みとあらばどこへでも駆けつけよう" } },
        { id: "3", name: "関大輔", username: "関", cate: "マトリ", color: "#F95240", scenario: { 0: "" } },
        { id: "4", name: "夏目春", username: "hal", cate: "マトリ", color: "#59D9A5", scenario: { 0: "あ" } },
        { id: "5", name: "今大路峻", username: "shun", cate: "マトリ", color: "#F9CD00", scenario: { 0: "今大路です。これからよろしくお願いします" } },
        { id: "6", name: "渡部悟", username: "ワタベ", cate: "マトリ", color: "#9173E7", scenario: { 0: "登録したよ、これから好きな時に連絡してね" } },
        { id: "7", name: "朝霧司", username: "朝霧 司", cate: "警視庁", color: "#FF864A", scenario: { 0: "朝霧司です", 1: "登録しましたので、早めに返事がほしい時はこちらにお願いします" } },
        { id: "8", name: "菅野夏樹", username: "夏樹", cate: "警視庁", color: "#98DF00", scenario: { 0: "送れてる？" } },
        { id: "9", name: "荒木田蒼生", username: "荒木田", cate: "警視庁", color: "#8FDAC6", scenario: { 0: "登録した。" } },
        { id: "10", name: "服部耀", username: "服部", cate: "警視庁", color: "#D43767", scenario: { 0: "夏樹から資料受け取った？" } },
        { id: "11", name: "桧山貴臣", username: "桧山", cate: "Revel", color: "#E3CC96", scenario: { 0: "" } },
        { id: "12", name: "大谷羽鳥", username: "hatori", cate: "Revel", color: "#F76796", scenario: { 0: "LIME教えてくれてありがとう。", 1: "気軽に連絡してね。" } },
        { id: "13", name: "神楽亜貴", username: "Aki Kagura", cate: "Revel", color: "#76b6ed", scenario: { 0: "登録したから。", 1: "金曜仕事終わったらアトリエ集合ね。", 2: "分かった？", 3: "ねえ、" } },
        { id: "14", name: "槙慶太", username: "槙慶太", cate: "Revel", color: "#5bcd38", scenario: { 0: "登録した、よろしく。" } },
        { id: "15", name: "都築誠", username: "都築", cate: "都築兄弟", color: "#4c835b", scenario: { 0: "先日は、取材の申し込みに応じてもらい助かった。", 1: "改めて礼を言う" } },
        { id: "16", name: "都築京介", username: "きょーすけ", cate: "都築兄弟", color: "#b9b3f4", scenario: { 0: "登録したよ、よろしく！" } },
        { id: "17", name: "新堂清志", username: "新堂", cate: "九条家", color: "#a481c8", scenario: { 0: "新堂だ" } },
        { id: "18", name: "山崎カナメ", username: "kaname", cate: "九条家", color: "#addbe3", scenario: { 0: "とどいてるか？" } },
        { id: "19", name: "桐嶋宏弥", username: "キリシマ", cate: "九条家", color: "#ffa126", scenario: { 0: "連絡先、もらってから時間経っちゃってごめん。" } },
        { id: "20", name: "九条壮馬", username: "九条", cate: "九条家", color: "#d22d38", scenario: { 0: "無事に登録できているだろうか。" } },
        { id: "21", name: "宮瀬豪", username: "宮瀬", cate: "九条家", color: "#f8a9f2", scenario: { 0: "夜ご飯お願いします。", 1: "あれ", 2: "よろしくと打つつもりが『よ』で勝手に変換が……" } },
        { id: "22", name: "可愛ひかる", username: "かわいひかる", cate: "瀬尾研究室", color: "#ff9ab5", scenario: { 0: "玲さん、ひかるんだよ～", 1: "早速登録させてね♪" } },
        { id: "23", name: "宝生潔", username: "宝生潔", cate: "瀬尾研究室", color: "#aeb227", scenario: { 0: "" } },
        { id: "24", name: "日向志音", username: "しー", cate: "瀬尾研究室", color: "#36dbf3", scenario: { 0: "さっき貰ったお菓子、おいしかった", 1: "ありがとう" } },
        { id: "25", name: "早乙女郁人", username: "早乙女郁人【淑央大】", cate: "瀬尾研究室", color: "#3553af", scenario: { 0: "これが俺のアカウントだ、\nきちんと登録しとけ", 1: "おい", 2: "おい、見てないのか。" } },
        { id: "26", name: "瀬尾鳴海", username: "NARUMI SEO", cate: "瀬尾研究室", color: "#218379", scenario: { 0: "これで登録できているかな？" } }
    ];

    group = CharaData.reduce((group, key) => {
        (group[key.cate] = group[key.cate] || []).push(key);
        return group;
    }, {});

    console.log(group);

    //キャラデータからメニューとチャットタブを生成
    let ChatArea = document.getElementsByClassName('chat-area');
    let Chara = document.getElementsByClassName('chara');
    let Menu = document.getElementById('js-menu');
    let MenuBtn = document.getElementById('js-menuBtn');
    let CharaList = document.getElementById('js-chara-list');
    let GroupList = document.getElementById('js-group-list');

    for (i = 0; i < CharaData.length; i++) {
        //サイドバーリスト
        const Chara = document.createElement('li');
        Chara.className = 'chara';
        Chara.id = CharaData[i].id;
        const CharaIcon = document.createElement('div');
        CharaIcon.className = 'chara-icon';
        CharaIcon.style.background = CharaData[i].color;
        const UserName = document.createElement('div');
        const UserNameText = document.createElement('span');
        UserNameText.textContent = CharaData[i].username;
        UserName.appendChild(UserNameText);
        UserName.className = 'chara-username';
        Chara.appendChild(CharaIcon);
        Chara.appendChild(UserName);
        CharaList.appendChild(Chara);

        //chat欄
        const Chat = document.createElement('div');
        Chat.className = 'chat-area menu-close';
        document.getElementsByClassName('chat-wrapper')[0].appendChild(Chat);

    }

    //group
    for (i = 0; i < 6; i++) {
        //サイドバーリスト
        const Group = document.createElement('li');
        Group.className = 'group';
        const GroupIcon = document.createElement('div');
        GroupIcon.className = 'chara-icon';
        GroupIcon.style.background = CharaData[i].color;
        const GroupName = document.createElement('div');
        const GroupNameText = document.createElement('span');
        GroupNameText.textContent = CharaData[i].username;
        GroupName.appendChild(GroupNameText);
        GroupName.className = 'chara-username';
        Group.appendChild(GroupIcon);
        Group.appendChild(GroupName);
        GroupList.appendChild(Group);

        //chat欄
        const Chat = document.createElement('div');
        Chat.className = 'chat-area menu-close';
        document.getElementsByClassName('chat-wrapper')[0].appendChild(Chat);

    }

    //キャラ選択
    CharaList.addEventListener('click', (e) => {
        CurrentCharaID = e.target.id;
        SelectChara(CurrentCharaID);
    });

    //キャラクターに応じて表示を変更
    SelectChara = (id) => {
        ChatArea[id].classList.add('chat-active');
        Chara[id].classList.add('chara-active');
        document.getElementById('js-sender-name').textContent = CharaData[id].username;

        for (i = 0; i < document.querySelectorAll('.chara').length; i++) {
            if (i != id && ChatArea[i].classList.contains('chat-active')) {
                ChatArea[i].classList.remove('chat-active');
            }
            if (i != id && Chara[i].classList.contains('chara-active')) {
                Chara[i].classList.remove('chara-active');
            }
        }
    }
    DefaultMessage = () => {
        for (i = 0; i < CharaData.length; i++) {
            scenarioLength = Object.values(CharaData[i].scenario).length;
            for (j = 0; j < scenarioLength; j++) {
                AddMessage(CharaData[i].scenario[j], "left", i)
            }
        }
    }



    /*
        document.getElementById('js-menu').append(CharaList);
        for (i = 0; i < CharaData.length; i++) {
            list = document.getElementsByClassName('chara-username')[i];
            listS = list.firstChild;
    
            if (list.clientWidth < listS.scrollWidth) {
    
                scrollLength = -(listS.scrollWidth - list.clientWidth) + "px";
                document.documentElement.style.setProperty('--scrollWidth', scrollLength);
                //listS.classList.add('animation');
                listS.style.animationName = "namescroll";
    
            }
    
        }
    
    */
    //Time
    let Time = document.getElementById('js-time');
    let timer = null;
    let timeTimer = null;

    const SetTime = () => {
        const now = new Date();
        let hours = now.getHours().toString();
        if (hours.length == 1) hours = '0' + hours;
        let minutes = now.getMinutes().toString();
        if (minutes.length == 1) minutes = '0' + minutes;
        Time.textContent = String(hours) + ':' + String(minutes);
        timeTimer = setTimeout(SetTime, (60 - now.getSeconds()) * 1000);
    };
    //battery
    let Battery = document.getElementById('js-battery');
    let BatteryIcon = document.createElement('i');

    const batteryLevel = () => {
        navigator.getBattery().then((battery) => {
            battery.addEventListener("levelchange", () => {
                updateLevelInfo();
            });
            function updateLevelInfo() {

                if (0.75 < battery.level && battery.level <= 1) {
                    BatteryIcon.className = 'fa-solid fa-battery-full fa-lg';
                } else if (0.5 < battery.level && battery.level <= 0.75) {
                    BatteryIcon.className = 'fa-solid fa-battery-three-quarters fa-lg';
                } else if (0.25 < battery.level && battery.level <= 0.5) {
                    BatteryIcon.className = 'fa-solid fa-battery-half fa-lg';
                } else if (0.2 < battery.level && battery.level <= 0.25) {
                    BatteryIcon.className = 'fa-solid fa-battery-quarter fa-lg';
                } else if (0.1 < battery.level && battery.level <= 0.2) {
                    BatteryIcon.className = 'fa-solid fa-battery-low fa-lg';
                } else if (0 < battery.level && battery.level <= 0.1) {
                    BatteryIcon.className = 'fa-solid fa-battery-empty fa-lg';
                }
                Battery.appendChild(BatteryIcon);
                level = Math.floor(battery.level * 100);
                document.querySelector('#js-battery span').textContent = String(level) + "%";
            };
            updateLevelInfo();
        });
    }
    //ブラウザ判定
    const batteryFlag = () => {
        const userAgent = window.navigator.userAgent.toLowerCase();
        if (userAgent.indexOf('edge') != -1 || userAgent.indexOf('chrome') != -1) {
            batteryLevel();
        } else if (userAgent.indexOf('safari') != -1) {
            document.querySelector('.battery span').textContent = "123%";
        }
    }
    //テキストエリア自動伸縮
    const TextBody = document.querySelector('#js-text');
    fontSize = (TextBody.currentStyle || document.defaultView.getComputedStyle(TextBody, '')).fontSize;
    lineHeight = (TextBody.currentStyle || document.defaultView.getComputedStyle(TextBody, '')).lineHeight;
    lineHeight = parseInt(lineHeight);
    const defaultHeight = (TextBody.currentStyle || document.defaultView.getComputedStyle(TextBody, '')).height;
    widthCountMax = 0;
    TextBody.addEventListener('input', () => {
        length = TextBody.value.length;
        row = Math.floor(TextBody.scrollHeight / lineHeight);
        widthCount = Math.floor(length / row);
        if (widthCount >= widthCountMax) { widthCountMax = widthCount; }
        if (TextBody.scrollHeight >= lineHeight * 2) {
            TextBody.style.height = 'auto';
            TextBody.style.height = TextBody.scrollHeight + 'px';
            if (length <= widthCountMax) {
                TextBody.style.height = defaultHeight;
            }
        }
    });

    //メッセージを作成
    AddMessage = (text, position, id) => {
        //text = text.replace(/\s+/g, '');

        if (!text.match(/\S/g) || text.textContent == '') {
            text.textContent = '';
            TextBody.style.height = defaultHeight;
            return;
        }


        position == 'right' ? position = 'right' : position = 'left';
        ChatArea[id];

        let fragment = document.createDocumentFragment();

        Message = document.createElement('div');
        Message.className = 'message message-' + position;
        Message.textContent = text;


        if (position == 'left') {
            MessageBox = document.createElement('div');
            MessageBox.className = 'messageBox-left';
            SenderIcon = document.createElement('div');
            SenderIcon.className = 'message-icon';
            SenderIcon.style.background = CharaData[id].color;
            MessageBox.appendChild(SenderIcon);
            MessageBox.appendChild(Message);
            fragment.append(MessageBox);
        } else if (position == 'right') {
            fragment.append(Message);
        }

        ChatArea[id].appendChild(fragment);
        TextBody.value = null;
        TextBody.style.height = defaultHeight;
        ChatArea[id].scrollTop = ChatArea[id].scrollHeight;

        Message.addEventListener('click', (e) => {
            let old_text = e.target.textContent;
            let new_text = window.prompt('メッセージ編集', old_text);
            if (new_text == null) {
                e.target.textContent = old_text;
                return;
            } else if (new_text == "") {
                if (window.confirm('削除しますか？')) {

                    if (e.target.className == 'message message-right') {
                        e.target.remove();
                        return;
                    } else if (e.target.className == 'message message-left') {
                        parent = e.target.closest('.messageBox-left');
                        parent.remove();
                        return;
                    }

                }
            } else if (new_text.length) {
                e.target.textContent = new_text;
                return;
            }
        });


    };

    //メッセージ送信者を選択(左右)
    formSender = document.querySelector('.form-sender');
    senderflag = true;
    formSender.addEventListener('click', function () {
        senderflag = !senderflag;
        formSender.classList.toggle('form-sender-L');
        formSender.classList.toggle('form-sender-R');
    });

    //メッセージ送信
    let Form = document.getElementById('js-form');
    Form.addEventListener('submit', (e) => {
        e.preventDefault();
        let messageText = TextBody.value;
        senderflag ? messagePosition = 'right' : messagePosition = 'left';
        AddMessage(messageText, messagePosition, CurrentCharaID);
    });

    //メニュー開閉
    MenuToggle = () => {
        menuflag = false;
        MenuBtnIcon = document.querySelector('#js-menuBtn i');
        MenuBtn.addEventListener('click', function () {
            menuflag = !menuflag;
            MenuBtn.classList.toggle('menu-open');
            MenuBtn.classList.toggle('menu-close');
            Menu.classList.toggle('menu-open');
            Menu.classList.toggle('menu-close');

            MenuBtnIcon.classList.toggle('fa-caret-right');
            MenuBtnIcon.classList.toggle('fa-caret-left');
            for (i = 0; i < CharaData.length; i++) {
                ChatArea[i].classList.toggle('menu-open');
                ChatArea[i].classList.toggle('menu-close');
            }

        });
    }

    //タブ

    SetTime();
    //batteryFlag();
    MenuToggle();
    //testメッセージ
    CurrentCharaID = 0;

    SelectChara(CurrentCharaID);
    DefaultMessage();
    //AddMessage("aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa","left",0)





</script>

</html>